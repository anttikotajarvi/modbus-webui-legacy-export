<!doctype html>
<meta charset="utf-8" />
<title>Modbus WebUI – Legacy Export</title>
<style>
  :root { color-scheme: light dark; }
  body { font:14px system-ui, sans-serif; max-width: 820px; margin: 3rem auto; padding: 0 1rem; }
  textarea { width:100%; min-height: 320px; font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space: pre; }
  .row { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
  .muted { opacity:.7 }
</style>

<h1>Modbus WebUI – Legacy Export</h1>
<p>This reads <code>localStorage["modbus:library:v1"]</code> on this origin and shows the JSON below.</p>

<div class="row">
  <button id="download">Download JSON</button>
  <button id="send">Send to new site</button>
  <button id="copy">Copy</button>
  <span id="meta" class="muted"></span>
</div>

<p class="muted">Library JSON (editable):</p>
<textarea id="exportText" spellcheck="false"></textarea>
<pre id="status" class="muted"></pre>

<script>
  const STORAGE_KEY = "modbus:library:v1";

  const qp = new URLSearchParams(location.search);
  const NEW_ORIGIN = qp.get("target") || "https://modbuswebui.dev";

  function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }

  function safeParseLibrary(raw) {
    if (raw == null) return undefined;
    let s = String(raw).trim();

    // unwrap single or double quotes if present
    if ((s.startsWith("'") && s.endsWith("'")) || (s.startsWith('"') && s.endsWith('"'))) {
      s = s.slice(1, -1);
    }

    try { return JSON.parse(s); } catch {}
    // double-encoded? "\"{...}\""
    try {
      const once = JSON.parse(s);
      if (typeof once === "string") return JSON.parse(once);
    } catch {}
    return undefined;
  }

  function loadLibraryToTextarea() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const lib = safeParseLibrary(raw);
    const ta = document.getElementById("exportText");
    if (!raw) {
      ta.value = "";
      setStatus(`No data found under "${STORAGE_KEY}".`);
      document.getElementById("meta").textContent = `Target: ${NEW_ORIGIN}`;
      return;
    }
    if (!lib) {
      ta.value = String(raw);
      setStatus(`Value under "${STORAGE_KEY}" is not valid JSON. Edit/fix it below or download as-is.`);
    } else {
      ta.value = JSON.stringify(lib, null, 2); // ONLY the library object
      setStatus("Loaded library.");
    }
    const bytes = new Blob([ta.value]).size;
    document.getElementById("meta").textContent = `${bytes.toLocaleString()} bytes · Target: ${NEW_ORIGIN}`;
  }

  document.getElementById("download").onclick = () => {
    const text = document.getElementById("exportText").value;
    const blob = new Blob([text], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), {
      href: url, download: "modbus-webui-library.json"
    });
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    setStatus("Downloaded JSON.");
  };

  document.getElementById("copy").onclick = async () => {
    try {
      await navigator.clipboard.writeText(document.getElementById("exportText").value);
      setStatus("Copied to clipboard.");
    } catch { setStatus("Clipboard blocked. Select & copy manually."); }
  };

  document.getElementById("send").onclick = () => {
    const text = document.getElementById("exportText").value;
    let payload;
    try { payload = JSON.parse(text); }
    catch { setStatus("Current text is not valid JSON."); return; }

    if (window.opener) {
      window.opener.postMessage({ type: "MODBUS_WEBUI_LEGACY_EXPORT", data: payload }, NEW_ORIGIN);
      setStatus("Sent to opener via postMessage.");
    } else {
      setStatus("No opener window. Open this page from the new site's importer.");
    }
  };

  window.addEventListener("DOMContentLoaded", loadLibraryToTextarea);
</script>
